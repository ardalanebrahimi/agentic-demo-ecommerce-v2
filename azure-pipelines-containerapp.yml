trigger:
  branches:
    include:
      - main
  paths:
    include:
      - backend/**
      - azure-pipelines-containerapp.yml

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'AzureSubscription1'
  resourceGroup: 'ardiland'
  containerAppName: 'agentic-demo-ecommerce-api'
  containerRegistry: 'ardilandacr'
  imageName: 'ecommerce-api'
  location: 'westeurope'

stages:
  - stage: Build
    displayName: 'Build and Push'
    jobs:
      - job: Build
        displayName: 'Build Docker Image'
        steps:
          - task: AzureCLI@2
            displayName: 'Create ACR if not exists'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Create ACR if it doesn't exist
                az acr show --name $(containerRegistry) --resource-group $(resourceGroup) 2>/dev/null || \
                az acr create --name $(containerRegistry) --resource-group $(resourceGroup) --sku Basic --admin-enabled true

          - task: AzureCLI@2
            displayName: 'Build and Push to ACR'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Build and push using ACR Tasks (no local Docker needed)
                az acr build \
                  --registry $(containerRegistry) \
                  --image $(imageName):$(Build.BuildId) \
                  --image $(imageName):latest \
                  --file backend/Dockerfile \
                  backend/

  - stage: Deploy
    displayName: 'Deploy to Container App'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: Deploy
        displayName: 'Deploy'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Deploy to Container App'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az extension add --name containerapp --upgrade -y

                      # Get ACR credentials
                      ACR_SERVER=$(az acr show --name $(containerRegistry) --query loginServer -o tsv)
                      ACR_USERNAME=$(az acr credential show --name $(containerRegistry) --query username -o tsv)
                      ACR_PASSWORD=$(az acr credential show --name $(containerRegistry) --query "passwords[0].value" -o tsv)

                      # Configure registry credentials for the container app
                      az containerapp registry set \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --server ${ACR_SERVER} \
                        --username ${ACR_USERNAME} \
                        --password ${ACR_PASSWORD}

                      # Update container app with new image
                      az containerapp update \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --image ${ACR_SERVER}/$(imageName):$(Build.BuildId)
